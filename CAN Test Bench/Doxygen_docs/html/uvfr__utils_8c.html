<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EVRTOSProject: Core/Src/uvfr_utils.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">EVRTOSProject
   &#160;<span id="projectnumber">V1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('uvfr__utils_8c.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">uvfr_utils.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="uvfr__utils_8h_source.html">uvfr_utils.h</a>&quot;</code><br />
</div>
<p><a href="uvfr__utils_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a6d40598f9d8daa89ca159a2e87f4fd01"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="uvfr__utils_8c.html#a6d40598f9d8daa89ca159a2e87f4fd01">uvInit</a> (void *arguments)</td></tr>
<tr class="memdesc:a6d40598f9d8daa89ca159a2e87f4fd01"><td class="mdescLeft">&#160;</td><td class="mdescRight">: Function that initializes all of the car's stuff.  <a href="uvfr__utils_8c.html#a6d40598f9d8daa89ca159a2e87f4fd01">More...</a><br /></td></tr>
<tr class="separator:a6d40598f9d8daa89ca159a2e87f4fd01"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02781145b4802ebdc7001800bbe6d994"><td class="memItemLeft" align="right" valign="top">enum <a class="el" href="uvfr__utils_8h.html#a71c52c44be11d0980910401cb9b5fb9e">uv_status_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="uvfr__utils_8c.html#a02781145b4802ebdc7001800bbe6d994">uvUtilsReset</a> ()</td></tr>
<tr class="memdesc:a02781145b4802ebdc7001800bbe6d994"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function is a soft-reboot of the uv_utils_backend and OS abstraction.  <a href="uvfr__utils_8c.html#a02781145b4802ebdc7001800bbe6d994">More...</a><br /></td></tr>
<tr class="separator:a02781145b4802ebdc7001800bbe6d994"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab80c00a024c34da7f7926212ce10ef01"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="uvfr__utils_8c.html#ab80c00a024c34da7f7926212ce10ef01">setup_extern_devices</a> (void *argument)</td></tr>
<tr class="separator:ab80c00a024c34da7f7926212ce10ef01"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3680dbdd328bffe299521c704147d587"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="uvfr__utils_8c.html#a3680dbdd328bffe299521c704147d587">_uvInitPanic</a> ()</td></tr>
<tr class="separator:a3680dbdd328bffe299521c704147d587"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a2d14399b3d64f2ddb952cdac5b30da7d"><td class="memItemLeft" align="right" valign="top">osThreadId&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="uvfr__utils_8c.html#a2d14399b3d64f2ddb952cdac5b30da7d">initTaskHandle</a></td></tr>
<tr class="memdesc:a2d14399b3d64f2ddb952cdac5b30da7d"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function will initialize all of the uvfr wrappers, and system variables, as well as performing internal diagnostics.  <a href="uvfr__utils_8c.html#a2d14399b3d64f2ddb952cdac5b30da7d">More...</a><br /></td></tr>
<tr class="separator:a2d14399b3d64f2ddb952cdac5b30da7d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a3680dbdd328bffe299521c704147d587"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3680dbdd328bffe299521c704147d587">&#9670;&nbsp;</a></span>_uvInitPanic()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void _uvInitPanic </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="uvfr__utils_8c_source.html#l00182">182</a> of file <a class="el" href="uvfr__utils_8c_source.html">uvfr_utils.c</a>.</p>

</div>
</div>
<a id="ab80c00a024c34da7f7926212ce10ef01"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab80c00a024c34da7f7926212ce10ef01">&#9670;&nbsp;</a></span>setup_extern_devices()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_extern_devices </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>argument</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="uvfr__utils_8c_source.html#l00177">177</a> of file <a class="el" href="uvfr__utils_8c_source.html">uvfr_utils.c</a>.</p>

</div>
</div>
<a id="a6d40598f9d8daa89ca159a2e87f4fd01"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6d40598f9d8daa89ca159a2e87f4fd01">&#9670;&nbsp;</a></span>uvInit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void uvInit </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>arguments</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>: Function that initializes all of the car's stuff. </p>
<p>This is an RTOS task, and it serves to setup all of the car's different functions. at this point in our execution, we have already initialized all of our favorite hardware peripherals using HAL. Now we get to configure our convoluted system of OS-level settings and state machines. </p>
<p>First on the block is our settings. The uv_settings are a bit strange, in the following way. We will check if we have saved custom settings, or if these settings are the default or not. It will then perform a checksum on the settings, and validate them to ensure they are safe If it fails to validate the settings, it will attempt to return to factory default.</p>
<p>If it is unable to return even to factory default settings, then we are in HUGE trouble, and some catastrophic bug has occurred. If it fails to even start this, it will not be safe to drive We must therefore panic.</p>
<p>Next up we will attempt to initialize the state engine. If this fails, then we are in another case where we are genuinely unsafe to drive. This will create the prototypes for a bajillion tasks that will be started and stopped. Which tasks are currently running, depends on the whims of the state engine. Since the state engine is critical to our ability to handle errors and implausibilitys, we cannot proceed without a fully operational state engine.</p>
<p>Once we have initialized the state engine, what we want to do is create the prototypes of all the tasks that will be running.</p>
<p>Now we are going to create a bunch of tasks that will initialize our car's external devices. The reason that these are RTOS tasks, is that it takes a buncha time to verify the existance of some devices. As a direct result, we can sorta just wait around and check that each task sends a message confirming that it has successfully executed. :) However, first we need to actually create a Queue for these tasks to use </p><div class="fragment"><div class="line">  /</div>
<div class="line">QueueHandle_t init_validation_queue = xQueueCreate(8,<span class="keyword">sizeof</span>(<a class="code" href="structuv__init__task__response.html">uv_init_task_response</a>));</div>
<div class="line"><span class="keywordflow">if</span>(init_validation_queue == NULL){</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
</div><!-- fragment --><p> The next big thing on our plate is checking the status of all external devices we need, and initializing them with appropriate parameters. These are split into tasks because it takes a bit of time, especially for devices that need to be configured via CANBus such as the motor controller. That is why it is split the way it is, to allow these to run somewhat concurrently </p><div class="fragment"><div class="line">  /</div>
<div class="line"> </div>
<div class="line">osThreadDef_t MC_init_thread = {<span class="stringliteral">&quot;MC_init&quot;</span>,<a class="code" href="motor__controller_8h.html#aed1407e1e0fd59dc7c5e5d6db671f0ab">MC_Startup</a>,osPriorityNormal,128,0};</div>
<div class="line"><a class="code" href="structuv__init__task__args.html">uv_init_task_args</a>* MC_init_args = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structuv__init__task__args.html">uv_init_task_args</a>));</div>
<div class="line">MC_init_args-&gt;<a class="code" href="structuv__init__task__args.html#adec47e7a54822cacfb8fcfc35a22157f">init_info_queue</a> = init_validation_queue;</div>
<div class="line">MC_init_args-&gt;<a class="code" href="structuv__init__task__args.html#a61a9b579a1e65a3875a4edf3201a39f3">specific_args</a> = NULL;</div>
<div class="line">MC_init_args-&gt;<a class="code" href="structuv__init__task__args.html#a88f1a118daecda734281396afd5e6eb1">meta_task_handle</a> = osThreadCreate(&amp;MC_init_thread,MC_init_args);</div>
<div class="line"> </div>
</div><!-- fragment --><p> This thread is for initializing the BMS </p><div class="fragment"><div class="line">  /</div>
<div class="line"> </div>
<div class="line">osThreadDef_t BMS_init_thread = {<span class="stringliteral">&quot;BMS_init&quot;</span>,<a class="code" href="bms_8h.html#aa9af83736568f74c94d41f3f16adf513">BMS_Init</a>,osPriorityNormal,128,0};</div>
<div class="line"><a class="code" href="structuv__init__task__args.html">uv_init_task_args</a>* BMS_init_args = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structuv__init__task__args.html">uv_init_task_args</a>));</div>
<div class="line">BMS_init_args-&gt;<a class="code" href="structuv__init__task__args.html#adec47e7a54822cacfb8fcfc35a22157f">init_info_queue</a> = init_validation_queue;</div>
<div class="line">BMS_init_args-&gt;<a class="code" href="structuv__init__task__args.html#a61a9b579a1e65a3875a4edf3201a39f3">specific_args</a> = NULL;</div>
<div class="line">BMS_init_args-&gt;<a class="code" href="structuv__init__task__args.html#a88f1a118daecda734281396afd5e6eb1">meta_task_handle</a> = osThreadCreate(&amp;BMS_init_thread,BMS_init_args);</div>
<div class="line"> </div>
</div><!-- fragment --><p> This variable is a tracker that tracks which devices have successfully initialized </p><div class="fragment"><div class="line"> /</div>
<div class="line"> </div>
<div class="line">uint16_t ext_devices_status = 0x000F; <span class="comment">//Tracks which devices are currently setup</span></div>
<div class="line"> </div>
<div class="line"> </div>
</div><!-- fragment --><p>Wait for all the spawned in tasks to do their thing. This should not take that long, but we wanna be sure that everything is chill If we are say, missing a BMS, then it will not allow you to proceed past the initialisation step This is handled by a message buffer, that takes inputs from all of the tasks</p>
<p>Clean up, clean up, everybody clean up, clean up, clean up, everybody do your share! The following code cleans up all the threads that were running, and free up used memory</p>

<p class="definition">Definition at line <a class="el" href="uvfr__utils_8c_source.html#l00030">30</a> of file <a class="el" href="uvfr__utils_8c_source.html">uvfr_utils.c</a>.</p>

<p class="reference">References <a class="el" href="uvfr__utils_8h_source.html#l00041">_BV_16</a>, <a class="el" href="bms_8c_source.html#l00011">BMS_Init()</a>, <a class="el" href="uvfr__utils_8h_source.html#l00184">uv_init_task_response::device</a>, <a class="el" href="uvfr__utils_8h_source.html#l00186">uv_init_task_response::errmsg</a>, <a class="el" href="uvfr__utils_8h_source.html#l00059">INIT_CHECK_PERIOD</a>, <a class="el" href="uvfr__utils_8h_source.html#l00173">uv_init_task_args::init_info_queue</a>, <a class="el" href="freertos_8c_source.html#l00050">initTaskHandle</a>, <a class="el" href="uvfr__utils_8h_source.html#l00057">MAX_INIT_TIME</a>, <a class="el" href="motor__controller_8c_source.html#l00259">MC_Startup()</a>, <a class="el" href="uvfr__utils_8h_source.html#l00174">uv_init_task_args::meta_task_handle</a>, <a class="el" href="uvfr__utils_8h_source.html#l00185">uv_init_task_response::nchar</a>, <a class="el" href="uvfr__utils_8h_source.html#l00172">uv_init_task_args::specific_args</a>, <a class="el" href="uvfr__utils_8h_source.html#l00183">uv_init_task_response::status</a>, <a class="el" href="uvfr__utils_8h_source.html#l00068">UV_OK</a>, <a class="el" href="uvfr__state__engine_8c_source.html#l00102">uvInitStateEngine()</a>, and <a class="el" href="uvfr__settings_8c_source.html#l00038">uvSettingsInit()</a>.</p>

<p class="reference">Referenced by <a class="el" href="freertos_8c_source.html#l00084">MX_FREERTOS_Init()</a>.</p>

</div>
</div>
<a id="a02781145b4802ebdc7001800bbe6d994"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a02781145b4802ebdc7001800bbe6d994">&#9670;&nbsp;</a></span>uvUtilsReset()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="uvfr__utils_8h.html#a71c52c44be11d0980910401cb9b5fb9e">uv_status_t</a> uvUtilsReset </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function is a soft-reboot of the uv_utils_backend and OS abstraction. </p>
<p>The idea here is to basically start from a blank slate and boot up everything. So therefore we must: Halt state machine. Nuke vehicle operation related tasks. Nuke the state machine Nuke old settings</p>
<p>reinitialize uv_utils </p>

<p class="definition">Definition at line <a class="el" href="uvfr__utils_8c_source.html#l00172">172</a> of file <a class="el" href="uvfr__utils_8c_source.html">uvfr_utils.c</a>.</p>

<p class="reference">References <a class="el" href="uvfr__utils_8h_source.html#l00068">UV_OK</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a2d14399b3d64f2ddb952cdac5b30da7d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d14399b3d64f2ddb952cdac5b30da7d">&#9670;&nbsp;</a></span>initTaskHandle</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">osThreadId initTaskHandle</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function will initialize all of the uvfr wrappers, and system variables, as well as performing internal diagnostics. </p>
<p>This function has 3 phases. 1) It loads up settings from flash if they exist. 2) It starts up the uv_state_engine</p>
<p>File Name : <a class="el" href="freertos_8c.html">freertos.c</a> Description : Code for freertos applications</p>
<dl class="section attention"><dt>Attention</dt><dd></dd></dl>
<p>Copyright (c) 2024 STMicroelectronics. All rights reserved.</p>
<p>This software is licensed under terms that can be found in the LICENSE file in the root directory of this software component. If no LICENSE file comes with this software, it is provided AS-IS. </p>

<p class="definition">Definition at line <a class="el" href="freertos_8c_source.html#l00050">50</a> of file <a class="el" href="freertos_8c_source.html">freertos.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="freertos_8c_source.html#l00084">MX_FREERTOS_Init()</a>, and <a class="el" href="uvfr__utils_8c_source.html#l00030">uvInit()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="amotor__controller_8h_html_aed1407e1e0fd59dc7c5e5d6db671f0ab"><div class="ttname"><a href="motor__controller_8h.html#aed1407e1e0fd59dc7c5e5d6db671f0ab">MC_Startup</a></div><div class="ttdeci">void MC_Startup(void *args)</div><div class="ttdef"><b>Definition:</b> <a href="motor__controller_8c_source.html#l00259">motor_controller.c:259</a></div></div>
<div class="ttc" id="abms_8h_html_aa9af83736568f74c94d41f3f16adf513"><div class="ttname"><a href="bms_8h.html#aa9af83736568f74c94d41f3f16adf513">BMS_Init</a></div><div class="ttdeci">void BMS_Init(void *args)</div><div class="ttdef"><b>Definition:</b> <a href="bms_8c_source.html#l00011">bms.c:11</a></div></div>
<div class="ttc" id="astructuv__init__task__response_html"><div class="ttname"><a href="structuv__init__task__response.html">uv_init_task_response</a></div><div class="ttdef"><b>Definition:</b> <a href="uvfr__utils_8h_source.html#l00182">uvfr_utils.h:182</a></div></div>
<div class="ttc" id="astructuv__init__task__args_html_adec47e7a54822cacfb8fcfc35a22157f"><div class="ttname"><a href="structuv__init__task__args.html#adec47e7a54822cacfb8fcfc35a22157f">uv_init_task_args::init_info_queue</a></div><div class="ttdeci">QueueHandle_t init_info_queue</div><div class="ttdef"><b>Definition:</b> <a href="uvfr__utils_8h_source.html#l00173">uvfr_utils.h:173</a></div></div>
<div class="ttc" id="astructuv__init__task__args_html_a88f1a118daecda734281396afd5e6eb1"><div class="ttname"><a href="structuv__init__task__args.html#a88f1a118daecda734281396afd5e6eb1">uv_init_task_args::meta_task_handle</a></div><div class="ttdeci">osThreadId meta_task_handle</div><div class="ttdef"><b>Definition:</b> <a href="uvfr__utils_8h_source.html#l00174">uvfr_utils.h:174</a></div></div>
<div class="ttc" id="astructuv__init__task__args_html"><div class="ttname"><a href="structuv__init__task__args.html">uv_init_task_args</a></div><div class="ttdoc">Struct designed to act like the uv_task_info struct, but for the initialisation tasks....</div><div class="ttdef"><b>Definition:</b> <a href="uvfr__utils_8h_source.html#l00171">uvfr_utils.h:171</a></div></div>
<div class="ttc" id="astructuv__init__task__args_html_a61a9b579a1e65a3875a4edf3201a39f3"><div class="ttname"><a href="structuv__init__task__args.html#a61a9b579a1e65a3875a4edf3201a39f3">uv_init_task_args::specific_args</a></div><div class="ttdeci">void * specific_args</div><div class="ttdef"><b>Definition:</b> <a href="uvfr__utils_8h_source.html#l00172">uvfr_utils.h:172</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_c6310732a22f63c0c2fc5595561e68f1.html">Core</a></li><li class="navelem"><a class="el" href="dir_b596f468b52957496e4f78b80e029268.html">Src</a></li><li class="navelem"><a class="el" href="uvfr__utils_8c.html">uvfr_utils.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
